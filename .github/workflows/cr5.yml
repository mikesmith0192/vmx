name: Parallel Remote Desktop Sessions with PIN and Backup

on:
  workflow_dispatch:
    inputs:
      crd_code_1:
        description: 'CRD Auth Code for Device 1'
        required: true
        type: string
      crd_code_2:
        description: 'CRD Auth Code for Device 2'
        required: true
        type: string
      crd_code_3:
        description: 'CRD Auth Code for Device 3'
        required: true
        type: string
      crd_code_4:
        description: 'CRD Auth Code for Device 4'
        required: true
        type: string
      crd_code_5:
        description: 'CRD Auth Code for Device 5'
        required: true
        type: string

jobs:
  remote_session:
    name: Remote Session ${{ matrix.device }}
    runs-on: windows-latest
    timeout-minutes: 360 # 6 hours

    strategy:
      fail-fast: false # Ensures other jobs continue if one fails
      matrix:
        device: [1, 2, 3, 4, 5]

    steps:
    - name: Set up CRD Code for Device ${{ matrix.device }}
      id: set_code
      shell: pwsh
      run: |
        if (${{ matrix.device }} -eq 1) { echo "CRD_CODE=${{ github.event.inputs.crd_code_1 }}" >> $env:GITHUB_ENV }
        if (${{ matrix.device }} -eq 2) { echo "CRD_CODE=${{ github.event.inputs.crd_code_2 }}" >> $env:GITHUB_ENV }
        if (${{ matrix.device }} -eq 3) { echo "CRD_CODE=${{ github.event.inputs.crd_code_3 }}" >> $env:GITHUB_ENV }
        if (${{ matrix.device }} -eq 4) { echo "CRD_CODE=${{ github.event.inputs.crd_code_4 }}" >> $env:GITHUB_ENV }
        if (${{ matrix.device }} -eq 5) { echo "CRD_CODE=${{ github.event.inputs.crd_code_5 }}" >> $env:GITHUB_ENV }

    - name: Install and Start Chrome Remote Desktop
      id: start_crd
      shell: pwsh
      run: |
        try {
          echo "Attempting to install and configure Chrome Remote Desktop..."
          Invoke-WebRequest -Uri "https://dl.google.com/dl/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd_host.msi"
          Start-Process msiexec.exe -Wait -ArgumentList '/i crd_host.msi /quiet'
          
          & "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" --code="${{ env.CRD_CODE }}" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="${{ env.COMPUTERNAME }}-${{ matrix.device }}" --pin="112233"
          
          echo "✅ Chrome Remote Desktop configured successfully."
          echo "You can connect to this machine with the name: ${{ env.COMPUTERNAME }}-${{ matrix.device }}"
          echo "The access PIN is: 112233"
        } catch {
          echo "❌ Chrome Remote Desktop setup failed. Proceeding to backup."
          Write-Error $_
          exit 1
        }

    - name: Setup RustDesk as Backup
      if: failure()
      id: setup_rustdesk # Give this step an ID to reference its output
      shell: pwsh
      run: |
        echo "⚠️ Initializing RustDesk as a backup..."
        Invoke-WebRequest -Uri "https://github.com/rustdesk/rustdesk/releases/download/1.2.3/rustdesk-1.2.3-x86_64.exe" -OutFile "rustdesk_installer.exe"
        Start-Process .\rustdesk_installer.exe -Wait -ArgumentList '--install --silent'
        
        # Allow time for the service to start
        Start-Sleep -Seconds 15
        
        # Set the static password
        & "$env:ProgramFiles\RustDesk\rustdesk.exe" --password "Password1"
        
        # Retrieve the RustDesk ID and set it as an output for the next step
        $rustdeskId = (& "$env:ProgramFiles\RustDesk\rustdesk.exe" --get-id).Trim()
        echo "id=$rustdeskId" >> $env:GITHUB_OUTPUT

    - name: Display RustDesk Credentials
      # This dedicated step runs only on failure to ensure credentials are shown clearly
      if: failure()
      run: |
        echo "✅ RustDesk has been configured as a backup."
        echo "=============================================="
        echo "  RUSTDESK ID: ${{ steps.setup_rustdesk.outputs.id }}"
        echo "  RUSTDESK PASSWORD: Password1"
        echo "=============================================="
        echo "Use these details in your RustDesk client to connect."

    - name: Keep Runner Alive
      if: always() # Runs regardless of success or failure to keep the session open
      shell: pwsh
      run: |
        echo "✅ Session is active. This runner will remain online for 6 hours."
        Start-Sleep -Seconds 21600 # 6 hours
