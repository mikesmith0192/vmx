name: CCRD10

on:
  # This section configures the manual trigger to ask for 5 auth codes.
  workflow_dispatch:
    inputs:
      auth_code_1:
        description: 'CRD Auth Code for Runner 1'
        required: true
        type: string
      auth_code_2:
        description: 'CRD Auth Code for Runner 2'
        required: true
        type: string
      auth_code_3:
        description: 'CRD Auth Code for Runner 3'
        required: true
        type: string
      auth_code_4:
        description: 'CRD Auth Code for Runner 4'
        required: true
        type: string
      auth_code_5:
        description: 'CRD Auth Code for Runner 5'
        required: true
        type: string
      
jobs:
  build:
    # The job name is dynamic and includes the runner ID from the matrix.
    name: Runner ${{ matrix.runner_id }}
    runs-on: windows-latest
    timeout-minutes: 360

    strategy:
      # This ensures that a failure in one job does not cancel the others.
      fail-fast: false
      matrix:
        runner_id: [1, 2, 3, 4, 5]
        # 'include' is used to map each runner ID to its corresponding auth code input.
        include:
          - runner_id: 1
            auth_code: ${{ github.event.inputs.auth_code_1 }}
          - runner_id: 2
            auth_code: ${{ github.event.inputs.auth_code_2 }}
          - runner_id: 3
            auth_code: ${{ github.event.inputs.auth_code_3 }}
          - runner_id: 4
            auth_code: ${{ github.event.inputs.auth_code_4 }}
          - runner_id: 5
            auth_code: ${{ github.event.inputs.auth_code_5 }}
          
    steps:
      - name: Download & Install Chrome Remote Desktop
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "chromeremotedesktophost.msi"
          Start-Process msiexec.exe -Wait -ArgumentList '/i chromeremotedesktophost.msi /quiet'

      - name: Start Chrome Remote Desktop Host with Admin Privileges
        # FIX: The 'uses' path is corrected to the proper repository owner 'k-t-corp'.
        # This action runs the command with SYSTEM privileges to avoid permission errors.
        uses: k-t-corp/run-as-admin@v1
        with:
          command: |
            & "${env:ProgramFiles(x86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" --code="${{ matrix.auth_code }}" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="$env:COMPUTERNAME-${{ matrix.runner_id }}" --pin=112233

      - name: Keep Runner Alive for 6 Hours
        # This single step keeps the job running for the desired duration.
        run: |
          $startTime = Get-Date
          $endTime = $startTime.AddSeconds(21600) # 6 hours
          Write-Host "Keep-alive timer started at $startTime. Will run for 6 hours."
          while ((Get-Date) -lt $endTime) {
            $elapsed = (Get-Date) - $startTime
            Write-Host "Workflow is running. Elapsed time: $($elapsed.Hours)h $($elapsed.Minutes)m $($elapsed.Seconds)s"
            Start-Sleep -Seconds 300  # Update status every 5 minutes
          }
          Write-Host "6-hour keep-alive timer completed at $(Get-Date)."
